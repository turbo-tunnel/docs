<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>透明代理 | Turbo Tunnel</title>
    <meta name="generator" content="VuePress 1.9.9">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6561463a45403780bdaed0b365f935a4";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <meta name="description" content="🚀 Fast tcp/https/websocket/socks4/socks5/ssh/icmp/k8s tunnel serving as unified proxy server.">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <link rel="preload" href="/assets/css/0.styles.20b07dd1.css" as="style"><link rel="preload" href="/assets/js/app.2f108697.js" as="script"><link rel="preload" href="/assets/js/4.6268aff2.js" as="script"><link rel="preload" href="/assets/js/3.0d9b0493.js" as="script"><link rel="preload" href="/assets/js/20.b4ce1760.js" as="script"><link rel="prefetch" href="/assets/js/1.8f418871.js"><link rel="prefetch" href="/assets/js/10.158ce785.js"><link rel="prefetch" href="/assets/js/11.22a8df43.js"><link rel="prefetch" href="/assets/js/12.366fd7fd.js"><link rel="prefetch" href="/assets/js/13.8c651667.js"><link rel="prefetch" href="/assets/js/14.c5e16a1f.js"><link rel="prefetch" href="/assets/js/15.b76a7f7b.js"><link rel="prefetch" href="/assets/js/16.9454e06a.js"><link rel="prefetch" href="/assets/js/17.f71f10ea.js"><link rel="prefetch" href="/assets/js/18.fd34a196.js"><link rel="prefetch" href="/assets/js/19.80641d68.js"><link rel="prefetch" href="/assets/js/21.d3699afd.js"><link rel="prefetch" href="/assets/js/5.3d7cd2c3.js"><link rel="prefetch" href="/assets/js/6.332ac9ca.js"><link rel="prefetch" href="/assets/js/7.9afb7287.js"><link rel="prefetch" href="/assets/js/8.0e4b65bc.js"><link rel="prefetch" href="/assets/js/9.cffe1c1b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.20b07dd1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-587a716c><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Turbo Tunnel</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/drunkdream/turbo-tunnel" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/drunkdream/turbo-tunnel" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">使用说明</a></li><li><a href="/port_forward.html" class="sidebar-link">端口转发</a></li><li><a href="/https.html" class="sidebar-link">HTTPS代理隧道</a></li><li><a href="/socks.html" class="sidebar-link">Socks代理隧道</a></li><li><a href="/websocket.html" class="sidebar-link">WebSocket隧道</a></li><li><a href="/ssh.html" class="sidebar-link">SSH隧道</a></li><li><a href="/icmp.html" class="sidebar-link">ICMP隧道</a></li><li><a href="/k8s.html" class="sidebar-link">K8S隧道</a></li><li><a href="/nested_tunnel.html" class="sidebar-link">嵌套隧道</a></li><li><a href="/config.html" class="sidebar-link">配置文件</a></li><li><a href="/transparent_proxy.html" aria-current="page" class="active sidebar-link">透明代理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/transparent_proxy.html#什么是透明代理" class="sidebar-link">什么是透明代理</a></li><li class="sidebar-sub-header"><a href="/transparent_proxy.html#常见的透明代理方案" class="sidebar-link">常见的透明代理方案</a></li><li class="sidebar-sub-header"><a href="/transparent_proxy.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/plugin.html" class="sidebar-link">扩展插件</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="透明代理"><a href="#透明代理" class="header-anchor">#</a> 透明代理</h1> <h2 id="什么是透明代理"><a href="#什么是透明代理" class="header-anchor">#</a> 什么是透明代理</h2> <p>透明代理是指不需要应用主动配置代理就可以自动通过代理访问服务的代理技术，这种情况下代理对应用完全透明，应用不会感知到代理的存在。相比于普通代理方式，这种方式不需要应用主动支持代理即可使用，因此应用范围更加广泛。</p> <p>透明代理分为全局透明代理和进程级透明代理，全局透明代理是指所有进程都会通过这个代理访问网络，一般是通过修改路由表或iptables之类的方式实现的（VPN就是一种最为常见的全局透明代理）；而进程级透明代理只对特定的进程生效，一般使用Hook Socket函数之类的方式实现。前者在使用上更加方便，使用时不需要对进程进行特殊处理；而后者则更加灵活，也更加安全一些（相当于访问网络有白名单机制）。</p> <p>透明代理很好地解决了许多应用不支持配置代理，导致在部分网络环境下无法正常使用的问题。</p> <h2 id="常见的透明代理方案"><a href="#常见的透明代理方案" class="header-anchor">#</a> 常见的透明代理方案</h2> <p>常见的透明代理实现原理：</p> <ul><li>修改路由表</li> <li>修改iptables</li> <li>Hook socket函数</li></ul> <p>下面介绍几种常见的透明代理工具：</p> <h3 id="proxifier"><a href="#proxifier" class="header-anchor">#</a> Proxifier</h3> <p><code>Proxifier</code>是一款跨平台的可视化全局透明代理管理工具，在Windows端主要是通过LSP自动在每个进程中注入DLL，然后Hook Socket函数来实现的。它支持<code>HTTP</code>、<code>Socks4</code>、<code>Socks5</code>等协议，并且可以配置路由规则，在使用上还是比较方便的。详细使用文档可以参考：<a href="https://www.xiequ.cn/httpproxy/contents/4/68.html" target="_blank" rel="noopener noreferrer">电脑全面变IP神器之：Proxifier使用指南<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>但它不支持<code>WSL</code>，因此WSL里的程序是无法通过Proxifier访问网络的。而且它对Mac端的兼容性不是很好，因此Mac端不太推荐使用该工具。</p> <h3 id="proxychains"><a href="#proxychains" class="header-anchor">#</a> proxychains</h3> <p>proxychains是一款Linux和MacOS上使用的命令行工具，将代理地址配置到配置文件后，在命令行前面加上<code>proxychains</code>就可以通过Hook socket函数进行透明代理。具体实现原理与使用方法可以参考<a href="https://www.drunkdream.com/2017/02/24/ubuntu-install-proxychains/" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>但是proxychains不支持策略路由，这种情况下可以借助<code>turbo-tunnel</code>达到这样的效果。</p> <ul><li>安装proxychains</li></ul> <p>Debian</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> proxychains4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>CentOS</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/rofl0r/proxychains-ng
<span class="token builtin class-name">cd</span> proxychains
./configure
<span class="token function">make</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>启动turbo-tunnel</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>turbo-tunnel <span class="token parameter variable">-c</span> ~/tunnel.yaml <span class="token parameter variable">-d</span> --auto-reload
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>~/tunnel.yaml</code>是配置文件，在里面指定代理服务监听在<code>http://127.0.0.1:9999</code>地址。</p> <ul><li>配置/etc/proxychains4.conf</li></ul> <div class="language-conf line-numbers-mode"><pre class="language-text"><code>strict_chain
proxy_dns 
# Some timeouts in milliseconds
tcp_read_time_out 15000
tcp_connect_time_out 8000

[ProxyList]
# add proxy here ...
# meanwile
# defaults set to &quot;tor&quot;
# socks4        127.0.0.1 9050
http 127.0.0.1 9999
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>通过proxychains访问目标服务</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>proxychains <span class="token function">curl</span> http://www.google.com/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过<code>tunnel.yaml</code>进行路由规则的管理，使得<code>proxychains</code>命令变得更加通用，降低了使用成本。</p> <blockquote><p>在Windows上如果想同时支持普通Windows应用以及WSL应用，可以通过<code>turbo-tunnel</code>先创建一个通用的本地代理，并配置好策略文件，然后Windows应用使用Proxifier进行代理，WSL应用使用proxychains进行代理。这种情况下，路由策略统一由turbo-tunnel进行管理，Proxifier仅用作透明代理。</p></blockquote> <h3 id="tun2socks"><a href="#tun2socks" class="header-anchor">#</a> tun2socks</h3> <p>tun2socks是一款跨平台的命令行工具，可以将网卡接收到的数据转发给socks5代理，因此可以通过这个工具实现全局透明代理。目前常见的实现有<a href="https://github.com/eycorsican/go-tun2socks" target="_blank" rel="noopener noreferrer">go-tun2socks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://github.com/xjasonlyu/tun2sockshttps://github.com/xjasonlyu/tun2socks" target="_blank" rel="noopener noreferrer">tun2socks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>下面介绍在Linux系统上的使用方法：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>turbo-tunel <span class="token parameter variable">-l</span> socks5://127.0.0.1:9999 <span class="token parameter variable">-t</span> http://192.168.0.1:8080/ <span class="token parameter variable">-d</span> --auto-reload
 
<span class="token function">ip</span> tuntap <span class="token function">add</span> mode tun dev tun1
<span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">240.0</span>.0.1 dev tun1
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev tun1 up

<span class="token function">ip</span> route del default
<span class="token function">ip</span> route <span class="token function">add</span> default via <span class="token number">240.0</span>.0.1
<span class="token function">ip</span> route <span class="token function">add</span> <span class="token number">192.168</span>.0.0/16 via <span class="token variable">$myip</span>

./tun2socks <span class="token parameter variable">-proxyServer</span> <span class="token number">127.0</span>.0.1:9999 <span class="token parameter variable">-loglevel</span> debug <span class="token parameter variable">-tunName</span> tun1 <span class="token parameter variable">-tunAddr</span> <span class="token number">240.0</span>.0.2 <span class="token parameter variable">-tunGw</span> <span class="token number">240.0</span>.0.1 <span class="token parameter variable">-proxyType</span> socks <span class="token parameter variable">-tunDns</span> <span class="token number">10.28</span>.0.12
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>首先使用<code>turbo-tunnel</code>创建一个<code>socks5</code>代理服务器，并转发给<code>192.168.0.1:8080</code>地址的<code>http</code>代理服务器。</p> <p>然后使用<code>ip tuntap add mode tun dev tun1</code>命令创建一个虚拟网卡，并通过<code>ip route add default via 240.0.0.1</code>命令将虚拟网卡设置为默认网卡，这样所有的流量都会发送到这个网卡；如果有部分地址必须直连，可以通过<code>ip route add 192.168.0.0/16 via $myip</code>的方式配置直连规则，<code>$myip</code>是真正连接网络的网卡ip。</p> <p>在<code>tun2socks</code>命令行中，<code>-tunName</code>参数指定刚才创建的虚拟网卡作为输入端，<code>-proxyServer</code>参数指定了上游代理服务器地址，代理服务器类型由<code>-proxyType</code>参数决定。</p> <p>tun2socks有一个问题，就是域名解析完全依赖本地的域名解析，无法使用服务端域名解析。这样，如果某些域名受到污染，就会导致访问受到影响。此时需要使用其它方案来解决域名污染问题。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>借助于透明代理工具和turbo-tunnel路由规则管理的能力，可以实现较为灵活的全局/进程级透明代理。具体使用哪款透明代理工具，取决于具体使用场景。全局透明代理在使用上更加方便，而进程级透明代理则更加灵活可控。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/turbo-tunnel/docs/edit/master/transparent_proxy.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/29/2023, 5:30:23 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/config.html" class="prev">
        配置文件
      </a></span> <span class="next"><a href="/plugin.html">
        扩展插件
      </a>
      →
    </span></p></div> <div class="theme-default-content gitalk-container" data-v-587a716c><div id="gitalk-container"></div></div> <div class="copyright" data-v-587a716c>
      Copyright © 2020 - 2023 ❤️ <a href="https://www.drunkdream.com/" target="_blank" data-v-587a716c>drunkdream</a></div> <div class="busuanzi" data-v-587a716c><span id="busuanzi_container_site_pv" style="display:none;" data-v-587a716c>
        本站总访问量
        <span id="busuanzi_value_site_pv" data-v-587a716c></span> 次
        <span class="post-meta-divider" data-v-587a716c>|</span></span> <span id="busuanzi_container_site_uv" style="display:none;" data-v-587a716c>
        本站访客数
        <span id="busuanzi_value_site_uv" data-v-587a716c></span> 人
      </span></div></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2f108697.js" defer></script><script src="/assets/js/4.6268aff2.js" defer></script><script src="/assets/js/3.0d9b0493.js" defer></script><script src="/assets/js/20.b4ce1760.js" defer></script>
  </body>
</html>
